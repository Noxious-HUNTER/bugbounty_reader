from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from webdriver_manager.chrome import ChromeDriverManager
from time import sleep
from tqdm import tqdm
import json

# تنظیمات Chrome
chrome_options = Options()
#chrome_options.add_argument("--headless")  # بدون باز شدن مرورگر
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.binary_location = "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"

# راه‌اندازی درایور
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)

# URL اصلی
base_url = "https://pentester.land/writeups/"
print(f"📡 Fetching: {base_url}")
driver.get(base_url)
sleep(3)

writeups = []

def extract_writeups_from_current_page():
    page_writeups = []
    try:
        rows = driver.find_elements(By.CSS_SELECTOR, "table tbody tr")
        for row in tqdm(rows, desc="Extracting writeups", unit="writeup"):
            try:
                title_elem = row.find_element(By.CSS_SELECTOR, "td:nth-child(1) a")
                title = title_elem.text
                link = title_elem.get_attribute('href')
                description = row.find_element(By.CSS_SELECTOR, "td:nth-child(2)").text
                date = row.find_element(By.CSS_SELECTOR, "td:nth-child(6)").text

                page_writeups.append({
                    "title": title,
                    "url": link,
                    "description": description,
                    "date": date
                })
            except Exception as e:
                print(f"⚠️ Error parsing row: {e}")
    except Exception as e:
        print(f"⚠️ Failed to extract rows: {e}")
    return page_writeups

# پردازش صفحات 1 تا 3
for page in range(1, 4):
    if page > 1:
        try:
            next_button = driver.find_element(By.CSS_SELECTOR, f'a.paginate_button[data-dt-idx="{page}"]')
            driver.execute_script("arguments[0].click();", next_button)
            sleep(3)
        except Exception as e:
            print(f"⚠️ Error going to page {page}: {e}")
            continue
    writeups += extract_writeups_from_current_page()

# ذخیره در فایل
with open('writeups_pentesterland_all.json', 'w') as f:
    json.dump(writeups, f, indent=4)

print(f"\n✅ Total writeups collected: {len(writeups)}")
driver.quit()
